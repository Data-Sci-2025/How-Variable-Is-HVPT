---
title: "How variable is HVPT input: Data pipeline"
format: gfm
---

```{r}
#| label: prereqs
#| include: false

library(readxl)
library(tidyverse)
library(dplyr)
library(rPraat)
library(purrr)
library(tidyr)
library(janitor)
library(phonR)
```


# Prerequisites

Before running this pipeline, you must have already:

1. [Retrieved the raw mp3 audio files](raw-data-retrieval-instructions.md),
2. [Converted them to wav files](audio-conversion-instructions.md),
3. [Used Praat to annotate, segment, and extract acoustic measurements.](praat-segmentation-instructions.md)


# Read in/Extract data and combine into one dataframe

## Start with VOT duration data

```{r}
#| label: import-data

# function for getting VOT duration
functionDur <- function(x) {
  tg <- tg.read(x)
  int <- which(pluck(tg, "VOT", "label") != "")
  tg.getIntervalDuration(tg, "VOT", int)
}

# get all TextGrid filepaths
paths <- list.files("sound-files", pattern = "[.]TextGrid$", full.names = TRUE)


# make a tibble with the filenames as a column, then map the function onto each to get durations 
filesDf <- tibble(file = paths)

votData <- filesDf |> 
  mutate(vot_duration_ms = map_dbl(file, functionDur))
         
# now rework the filenames using basename()
votData <- votData |> 
  mutate(file = basename(paths), .before = vot_duration_ms)

# extract variables from audio file names
votData <- votData |> 
  separate_wider_regex(
    file,
    patterns = c(
      word = "^[bp].+",
      "_",
      voicing = "voiced|voiceless",
      "_",
      sex = ".",
      "_",
      talker_id = "\\d+",
      "[_.]",
      rest = "\\S+")
  )

# we don't need that rest column
votData <- votData |> 
  select(!c(rest))

# make duration column into ms
votData <- votData |> 
  mutate(vot_duration_ms = vot_duration_ms*1000, .after = talker_id)

# make /b/ VOT negative: it's kind of annoying!
votDataB <- votData |> 
  filter(voicing == "voiced") |> 
  mutate(vot_duration_ms = vot_duration_ms * -1)

votDataP <- votData |> 
  filter(voicing == "voiceless")

votData <- rbind(votDataB, votDataP)

# add condition information
votData <- votData |> 
  mutate(two_talker = ifelse(talker_id == "928" | talker_id == "198", "y", "n"),
         six_talker = ifelse(word != "bacho" & word != "belo" & word != "bicho" & word != "bolo" & word != "bumo" & word != "pacho" & word != "pelo" & word != "picho" & word != "polo" & word != "pumo", "y", "n"))

# clean col names to be safe
votData <- clean_names(votData)

```

## Move on to formant data

```{r}
#| label: read-in-and-normalize-formant-data

formantData <- read_delim("sound-files/formant-data.txt")

# make all column names lowercase for ease/simplicity
colnames(formantData) <- tolower(colnames(formantData))

# duplicate filename so we can extract the vowel
formantData <- formantData |> 
  mutate(file = filename, .before = filename)

# extract the vowel from the filename
formantData <- formantData |> 
  separate_wider_regex(
    file,
    patterns = c(
      initial_stop = "^[bp]",
      vowel = "[aeiou]",
      rest = "\\S+")
  )

# extract info from the filenames we kept: don't mind the bug
formantData <- formantData |> 
  separate_wider_regex(
    filename,
    patterns = c(
      word = "^[bp].+",
      "_",
      voicing = "voiced|voiceless",
      "_",
      sex = ".",
      "_",
      talker_id = "\\d+"
      ),
    too_few = "debug"
  )

# clean up columns
formantData <- formantData |> 
  select(vowel, word:talker_id, f0:intensity_db)


# normalize formants
formantData <- formantData |> 
  group_by(talker_id) |> 
  mutate(f1lobanov = normLobanov(f1), 
         f2lobanov = normLobanov(f2))

# rename the norm columns
formantData <- formantData |> 
  rename(f1_norm = f1lobanov,
         f2_norm = f2lobanov)

# convert matrix lobanov cols into vectors
formantData$f1_norm <- formantData$f1_norm[,1]
formantData$f2_norm <- formantData$f2_norm[,1]

```

## Join the dataframes

```{r}
#| label: join-data-frames

# join dfs
allData <- formantData |> 
  left_join(votData)

# fix some names
allData |> 
  rename(vowel_duration_ms = duration_ms,
         vowel_intensity_db = intensity_db)

# change to factor
allData$voicing <- as.factor(allData$voicing)
allData$sex <- as.factor(allData$sex)
allData$talker_id <- as.factor(allData$talker_id)
allData$vowel <- as.factor(allData$vowel)

```


## Write cleaned data to new file

```{r}
#| label: write-data

# note that this is only the cleaned-up version of the full dataset
write_csv(allData, "stimuli-acoustics.csv")

```

# Analyses

## VOT


```{r}
#| label: all-items-by-talker-boxplot-voicing-facet

# make some labels
voicing_labels <- c(
  `voiced` = "/b/",
  `voiceless` = "/p/"
)

# plot
allData |> 
  ggplot(aes(x = talker_id, y = vot_duration_ms, fill = sex)) +
  geom_boxplot() +
  ylim(NA, 100) +
  scale_y_continuous(breaks = c(-200, -150, -100, -50, 0, 50, 100)) +
  scale_fill_manual(values = c("skyblue", "lightgoldenrod")) +
  theme_bw() +
  labs(x = "Talker",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) for /p/-/b/ by talker (all tokens)",
       fill = "Gender") +
  facet_wrap(~voicing, ncol = 2, labeller = labeller(voicing = voicing_labels))


# make a table of values
allData |> 
  group_by(talker_id, voicing) |> 
  summarize(mean_vot = mean(vot_duration_ms),
            sd_vot = sd(vot_duration_ms))
```

```{r}
#| label: b-VOT-by-vowel-all-items

allData |> 
  filter(voicing == "voiced") |> 
  ggplot(aes(x = vowel, y = vot_duration_ms)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Vowel",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) for /b/ by following vowel (all tokens)")
```

```{r}
#| label: p-VOT-by-vowel-all-items

allData |> 
  filter(voicing == "voiceless") |> 
  ggplot(aes(x = vowel, y = vot_duration_ms)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Vowel",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) for /p/ by following vowel (all tokens)")
```

```{r}
#| label: voicing-VOT-by-vowel-all-items

allData |> 
  ggplot(aes(x = vowel, y = vot_duration_ms)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Vowel",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) for /b/-/p/ by following vowel (all tokens)") +
  facet_wrap(~voicing, ncol = 2, labeller = labeller(voicing = voicing_labels))
```

```{r}
#| label: vot-by-talker-by-condition

# make data longer so each row has condition info
allDataLong <- allData |> 
  pivot_longer(!vowel:vot_duration_ms, names_to = "condition", values_to = "condition_true")

allDataLong$condition <- paste(allDataLong$condition, allDataLong$condition_true, sep = "_")

# limit to only "yes" conditions
allDataLongConditions <- allDataLong |> 
  filter(condition %in% c("six_talker_y", "two_talker_y"))

# make some labels
condition_labels <- c(
  `six_talker_y` = "six-talker",
  `two_talker_y` = "two-talker"
)

# plot
allDataLongConditions |> 
  ggplot(aes(x = talker_id, y = vot_duration_ms, fill = sex)) +
  geom_boxplot() +
  scale_fill_manual(values = c("skyblue", "lightgoldenrod")) +
  theme_bw() +
  labs(x = "Talker",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) by talker and condition",
       fill = "Gender") +
  facet_wrap(vars(condition, voicing), labeller = labeller(condition = condition_labels, voicing = voicing_labels))
```


```{r}
#| label: vot-by-condition

allDataLongConditions |> 
  ggplot(aes(x = voicing, y = vot_duration_ms)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Stop",
       y = "VOT duration (ms)",
       title = "VOT duration (ms) by condition") +
  facet_wrap(vars(condition), labeller = labeller(condition = condition_labels))

```


# Vowel Formants

- NOTE: Vowel space code was developed using [Dr. Marissa Barlaz's Vowel Normalization Workshop.](https://marissabarlaz.github.io/portfolio/vowelnormalization/)

```{r}
#| label: vowel-space-all-items

allData |> 
  ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space: All tokens")
```

```{r}
#| label: vowel-space-by-talker

allData |> 
  ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by talker") +
  facet_wrap(~talker_id, ncol = 2)

# make a table
allData |> 
  group_by(vowel) |> 
  summarize(mean_f1 = mean(f1_norm),
            sd_f1 = sd(f1_norm),
            mean_f2 = mean(f2_norm),
            sd_f2 = mean(f2_norm))

```

```{r}
#| label: vowel-space-by-talker-and-stop

# unfortunately this plot ends up practically unreadable
allData |> 
  ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by talker") +
  facet_wrap(vars(talker_id, voicing), ncol = 2, labeller = labeller(voicing = voicing_labels))
```


```{r}
#| label: vowel-space-by-stop

allData |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by stop (/b/ and /p/)") +
  facet_wrap(~voicing, ncol = 2, labeller = labeller(voicing = voicing_labels))
```

```{r}
#| label: vowel-space-by-gender

allData |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by gender") +
  facet_wrap(~sex, ncol = 2)
```

```{r}
#| label: vowel-space-by-gender-and-talker

# female talkers
allData |> 
  filter(sex == "f") |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by gender") +
  facet_wrap(~talker_id, ncol = 2)

# male talkers
allData |> 
  filter(sex == "m") |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by gender") +
  facet_wrap(~talker_id, ncol = 2)
```


```{r}
#| label: vowel-space-by-gender-and-stop

allData |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by gender and stop (/b/ and /p/") +
  facet_wrap(vars(sex, voicing), ncol = 2, labeller = labeller(voicing = voicing_labels))
```

```{r}
#| label: vowel-space-by-condition

allDataLongConditions |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by condition") +
  facet_wrap(~condition, ncol = 2, labeller = labeller(condition = condition_labels))
```

```{r}
#| label: vowel-space-by-condition-and-stop

allDataLongConditions |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by condition") +
  facet_wrap(vars(condition, voicing), ncol = 2, labeller = labeller(condition = condition_labels, voicing = voicing_labels))
```

```{r}
#| label: vowel-space-by-condition-and-gender

allDataLongConditions |> 
ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space by condition") +
  facet_wrap(vars(condition, sex), ncol = 2, labeller = labeller(condition = condition_labels))
```

```{r}
#| label: vowel-spaces-two-talkers-only

allDataLongConditions |> 
  filter(talker_id == "198" | talker_id == "928") |> 
  ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  stat_ellipse() +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel spaces for Talker 198 and Talker 928") +
  facet_wrap(~condition, ncol = 2, labeller = labeller(condition = condition_labels))
```

```{r}
#| label: vowel-spaces-two-talkers-only-and-stops

allDataLongConditions |> 
  filter(talker_id == "198" | talker_id == "928") |> 
  ggplot(aes(x = f2_norm, y = f1_norm, color = vowel)) +
  geom_point(aes(shape = vowel), alpha = 0.3) +
  theme_bw() +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_text(data = formantData |> 
  group_by(vowel) |> 
  summarize_at(vars(f1_norm:f2_norm), mean, na.rm = TRUE), aes(label = vowel), size = 8) +
  labs(x = "F2 (Lobanov-transformed)",
       y = "F1 (Lobanov-transformed)",
       title = "Vowel space for Talker 198 and Talker 928 by stop") +
  facet_wrap(vars(condition, voicing), ncol = 2, labeller = labeller(condition = condition_labels, voicing = voicing_labels))
```

#f0

```{r}
#| label: f0-by-talker-and-stop

allData |> 
  ggplot(aes(x = talker_id, y = f0, fill = sex)) +
  geom_boxplot() +
  scale_fill_manual(values = c("skyblue", "lightgoldenrod")) +
  theme_bw() +
  labs(x = "Talker",
       y = "f0 (Hz)",
       title = "f0 (Hz) by talker",
       fill = "Gender") +
  facet_wrap(~voicing, ncol = 2, labeller = labeller(voicing = voicing_labels))
```

```{r}
#| label: f0-by-vowel-and-gender

allData |> 
  ggplot(aes(x = vowel, y = f0, fill = sex)) +
  geom_boxplot() +
  scale_fill_manual(values = c("skyblue", "lightgoldenrod")) +
  theme_bw() +
  labs(x = "Vowel",
       y = "f0 (Hz)",
       title = "f0 (Hz) by gender and vowel",
       fill = "Gender") +
  facet_wrap(~voicing, ncol = 2, labeller = labeller(voicing = voicing_labels))
```

```{r}
#| label: f0-by-condition

allDataLongConditions |> 
  ggplot(aes(x = voicing, y = f0, fill = sex)) +
  geom_boxplot() +
  scale_fill_manual(values = c("skyblue", "lightgoldenrod")) +
  theme_bw() +
  labs(x = "Stop (voicing)",
       y = "f0 (Hz)",
       title = "f0 (Hz) by condition",
       fill = "Gender") +
  facet_wrap(~condition, ncol = 2, labeller = labeller(condition = condition_labels))
```


# Model

Using binary logistic regression to predict voicing (voiced = "1", voiceless = "0") from other predictor variables.

## Dummy code data

```{r}
#| label: dummy-code-voicing


# dummy code voicing predictor
allDataModel <- allData
allDataModel$voicing <- fct_recode(allDataModel$voicing,
                                   "0" = "voiceless",
                                   "1" = "voiced")
```

## Create models

```{r}
#| label: create-models

# predicting voicing from f0 of vowel
modelf0 <- glm(formula = voicing ~ f0, family = binomial, data = allDataModel)
summary(modelf0)

# predicting voicing from f1 of vowel
modelf1 <- glm(formula = voicing ~ f1_norm, family = binomial, data = allDataModel)
summary(modelf1)
```

```{r}
sessionInfo()
```



