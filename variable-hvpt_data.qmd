---
title: "How variable is HVPT input: Data pipeline"
format: gfm
---

```{r}
#| label: prereqs
#| include: false

library(tidyverse)
library(readxl)
```

# Prerequisites

You must have the software [Praat](https://praat.org/) installed on your machine to 
produce the acoustic values data.


# Audio retrieval and raw data gathering

This pipeline uses output from [Praat](https://praat.org/) using the training stimuli audio files from Nagle et al. (2025). These audio files are publicly accessible via their [OSF page](https://osf.io/mnks9/files).

## **Follow these steps for preparing the sound files for analyses:**

### Download the audio files

1. On the [Nagle et al. (2025) OSF Files page](https://osf.io/mnks9/files), navigate to `1 Materials` > `Training Materials` > `Training Stimuli 6-Talker Group` and click `Download As Zip` in the right-hand corner. 
    
2. Download the zip file to this directory (repository `How-Variable-Is-HVPT`) and extract the files by double-clicking on the zip file. 
    * Delete the *old* .zip file

3. Repeat Steps 2-3 for `Training Stimuli 2-Talker Group` from the same OSF folder.

### Rename the audio file folders

1. 
    
2. Convert the audio to wav files for Praat.
    * Follow the [audio conversion instructions](audio-conversion-instructions.md) for converting the mp3 files to wav files, which are necessary for input into Praat.

**Follow these steps for performing acoustic analysis in Praat**

1. Download [this Praat script](https://github.com/wendyelviragarcia/TextGrid_labels_extraction/blob/main/extracts_interval_labels.praat) and save it to your `sound-files` folder.
    * Click "Download as raw file"
    
2. **The wav files and TextGrids must all be in the same folder**
    * Download my [TextGrids](textgrids-VOT/) into the `sound-files` folder. Alternatively, you can copy them within R under the `Files` tab, checking the box next to the `textgrids` folder, clicking the gear icon, then `Copy To...` and selecting the `sound-files` folder.
    * It will likely add them as a folder within the `sound-files` folder. You will need to extract them and move them out, into the `sound-files` folder (you can highlight all the files and move or copy them to the `sound-files` folder).
    
2. Open Praat. In Praat, click `Open` > `Read from file...` and select the Praat script you just saved.

3. In the Praat script window, click `Run` (or Cmd/Ctrl + R)

4. When the form appears, (relative paths are not working, for now, you'll have to go to your file explorer and copy your full file path for `sound-files` and enter it into `Directory name` and **be sure to close it with a final slash**).

5. In `logfile` enter `raw-durations`

6. Click `okay` and this will save the text file to `sound-files`.

You're all done! You can now move on to reading in the `raw-durations` file into R.

# Read in raw data
```{r}
#| label: read-in

durations <- read.delim("./sound-files/raw-durations.txt", header = FALSE)
durations
```

## Information about raw data

The raw data is the output of a [Praat script](https://www.acsu.buffalo.edu/~cdicanio/scripts/Boundary_Extractor.praat) which retrieves timestamps for boundaries in TextGrids. I hand-annotated VOT for all 60 audio files used in the 6-talker condition in the original study (Nagle et al., 2025). The output includes the name of the TextGrid file for each audio file, the tier used for annotation and labels that I input here to indicate VOT ("lead" refers to negative VOT and "lag" refers to positive VOT), then the start time for each interval and the end time for each interval. There are 60 observations total, accounting for 2 segments x 5 vowel contexts x 6 talkers.

# Data transformation and tidying

My goal is to compare VOT durations across speakers used for HVPT stimuli, so in order to get to this point the raw data needs to be transformed and tidied. Thus, I will need a new data frame with the following components:

* Rename columns
* All empty Praat TextGrid tiers removed
* New column with VOT duration calculated (`end` - `start`) *in ms*
    * *Note that lead VOT is negative*
* Extract information from file names and move to new columns: Talker ID, gender/sex, word produced, and voicing
    
```{r}
#| label: data-transform

# rename columns 
durations <- durations |> 
  rename(file = "V1",
         label = "V2",
         start = "V3",
         end = "V4")

# extract variables from audio file names
durations <- durations |> 
  separate_wider_regex(
    file,
    patterns = c(
      word = "^[bp].+",
      "_",
      voicing = "voiced|voiceless",
      "_",
      sex = ".",
      "_",
      talker_id = "\\d+",
      "[_.]",
      rest = "\\S+")
  )

# we don't need that rest column
durations <- durations |> 
  select(word:talker_id, label:end)

# get rid of rows with empty intervals (no VOT info)
durations <- durations |> 
  filter(label == "lead" | label == "lag")

# add a column to get VOT duration
durations <- durations |> 
  mutate(VOT = (end - start)*1000)

```

## Write cleaned data to new file

```{r}
#| label: write-data

# note that this is only the cleaned-up version of the full dataset
write_csv(durations, "clean-durations.csv")
```

# Prepare subsets for analyses

The following are the questions I will be attempting to address with this project:

* To what extent do talkers vary in their productions of word-initial Spanish segments /b/ and /p/? (In other words, varied are the VOT durations for each segment between talkers and within talkers?)
* ...between sex?
* ...between voiced vs voiceless segments?
* ...between phonetic contexts (following vowel)?

In order to address these, I will need to make subsets of the data where it is grouped in different ways (e.g. a subset).

## Question A: What is the average VOT for /b/ and /p/ per speaker?

First, isolate each consonant:

```{r}
#| label: isolate-b-per-talker

# Talker 007

b007 <- durations |> 
  filter(talker_id == "007") |> 
  filter(voicing == "voiced")

# Talker 863

b863 <- durations |> 
  filter(talker_id == "863") |> 
  filter(voicing == "voiced")

# Talker 928

b928 <- durations |> 
  filter(talker_id == "928") |> 
  filter(voicing == "voiced")

# Talker 198

b198 <- durations |> 
  filter(talker_id == "198") |> 
  filter(voicing == "voiced")

# Talker 355

b355 <- durations |> 
  filter(talker_id == "355") |> 
  filter(voicing == "voiced")

# Talker 377

b377 <- durations |> 
  filter(talker_id == "377") |> 
  filter(voicing == "voiced")

```

```{r}
#| label: isolate-p-per-talker

# Talker 007

p007 <- durations |> 
  filter(talker_id == "007") |> 
  filter(voicing == "voiceless")

# Talker 863

p863 <- durations |> 
  filter(talker_id == "863") |> 
  filter(voicing == "voiceless")

# Talker 928

p928 <- durations |> 
  filter(talker_id == "928") |> 
  filter(voicing == "voiceless")

# Talker 198

p198 <- durations |> 
  filter(talker_id == "198") |> 
  filter(voicing == "voiceless")

# Talker 355

p355 <- durations |> 
  filter(talker_id == "355") |> 
  filter(voicing == "voiceless")

# Talker 377

p377 <- durations |> 
  filter(talker_id == "377") |> 
  filter(voicing == "voiceless")
```

### What is the average VOT for /b/ per talker?

Based on the data below, we can see that there is quite a bit of variability between VOT for /b/ per talker. Talker 007 has a very small VOT compared to the rest, and upon further inspection, this is the result of one of their tokens having a very short lead VOT (around -20 ms) compared to other tokens, which is possibly due to the recording quality.

```{r}
# get means for each talker for VOT of /b/ and assign to vectors

b_names <- c("007", "198", "355", "377", "863", "928")
b_means <- c(mean(b007$VOT), mean(b198$VOT), mean(b355$VOT), mean(b377$VOT), mean(b863$VOT), mean(b928$VOT))

# use the vectors to make a new df showing the mean VOT for /b/ for each talker

b_VOT_talker <- tibble(
  talker_id = b_names,
  mean_VOT = b_means
)
```

### What is the average VOT for /p/ per talker?

Visually, the VOTs for /p/ are much less variable across talkers.

```{r}
# get means for each talker for VOT of /p/ and assign to vectors

p_names <- c("007", "198", "355", "377", "863", "928")
p_means <- c(mean(p007$VOT), mean(p198$VOT), mean(p355$VOT), mean(p377$VOT), mean(p863$VOT), mean(p928$VOT))

# use vectors to make a new df showing the mean VOT for /p/ for each talker
p_VOT_talker <- tibble(
  talker_id = p_names,
  mean_VOT = p_means
)
```
